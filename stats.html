<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Pro | Analytics</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .sidebar { height: 100vh; background: #212529; color: white; position: fixed; width: 240px; }
        .main-content { margin-left: 240px; padding: 30px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 2rem; font-weight: 700; color: #0d6efd; }
        .chart-wrapper { position: relative; height: 300px; }
        .badge-priority { width: 10px; height: 10px; display: inline-block; border-radius: 50%; margin-right: 5px; }
    </style>
</head>
<body>

<div class="sidebar d-flex flex-column p-3">
    <h4 class="mb-4 text-primary">Productivity Helper</h4>
    <hr>
    <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item mb-2">
            <a href="index.html" class="nav-link text-white">Tasks</a>
        </li>
        <li>
            <a href="#" class="nav-link active">Analytics</a>
        </li>
    </ul>
    <div class="dropdown">
        <hr>
        <span class="small text-secondary">V 2.0 (Analytics Beta)</span>
    </div>
</div>

<div class="main-content">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Analytics Dashboard</h2>
            <button id="refresh-data" class="btn btn-outline-primary btn-sm">Refresh Data</button>
        </div>
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card p-3">
                    <h6 class="text-muted">Task Completed Velocity</h6>
                    <div id="m-task-velocity" class="stat-value">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h6 class="text-muted">Task Creation Velocity</h6>
                    <div id="m-task-create-velocity" class="stat-value text-success">0</div>
                </div>
            </div>

        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card p-3">
                    <h6 class="text-muted">Total Time Spent</h6>
                    <div id="m-total-time" class="stat-value">0h 0m</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h6 class="text-muted">Avg. Focus Score</h6>
                    <div id="m-focus" class="stat-value text-success">0.0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h6 class="text-muted">Estimation Accuracy Rate</h6>
                    <div id="m-accuracy" class="stat-value text-warning">0%</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h6 class="text-muted">High Energy Tasks</h6>
                    <div id="m-energy" class="stat-value text-danger">0</div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card p-4">
                    <h5 class="mb-3">Time Allocation per Project</h5>
                    <div class="chart-wrapper">
                        <canvas id="projectPie"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card p-4">
                    <h5 class="mb-3">Estimated vs. Actual (Minutes)</h5>
                    <div class="chart-wrapper">
                        <canvas id="accuracyBar"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card p-4">
                    <h5 class="mb-3">Recent Task Log</h5>
                    <div class="table-responsive">
                        <table class="table table-hover mt-2">
                            <thead class="table-light">
                                <tr>
                                    <th>Task</th>
                                    <th>Project</th>
                                    <th>Priority</th>
                                    <th>Focus</th>
                                    <th>Time Delta</th>
                                </tr>
                            </thead>
                            <tbody id="task-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // 1. DATA (Replacing with Mock for now)
    // const storedTasks = [
    //     { name: "Fix Space RPG Bug", project: "GameDev", est: 60, actual: 95, p: 1, focus: 4, energy: "High" },
    //     { name: "LinkedIn Profile Update", project: "JobSearch", est: 45, actual: 30, p: 2, focus: 5, energy: "Low" },
    //     { name: "Server Setup RPi400", project: "GameDev", est: 120, actual: 110, p: 1, focus: 3, energy: "High" },
    //     { name: "Yoga Session", project: "Health", est: 90, actual: 90, p: 2, focus: 5, energy: "High" }
    // ];

    const storedTasks = JSON.parse(localStorage.getItem('tasks')) || [];

    $(document).ready(function() {
        renderDashboard(storedTasks);

        $("#refresh-data").click(function() {
            location.reload(); 
        });
    });

    function renderDashboard(data) {
        let totalMins = 0, totalEst = 0, sumFocus = 0, highEnergyCount = 0;
        let taskVelocity = {completedVelocity: 0, createdVelocity: 0};
        
        // Clear Table
        $("#task-table-body").empty();

        data.forEach(task => {
            totalMins += (task.timeSpent / 60000 || 0);
            totalEst += task.timeEstimate;
            sumFocus += parseInt(task.focusScore) || 0;
            if(task.energyLevel === "High") highEnergyCount++;
            if (task.createdAt) {
                const startOfWeek = (createdAt) => {
                    if (!createdAt) return null; // Return null if createdAt is falsy
                    const date = new Date(createdAt);
                    return new Date(date.setDate(date.getDate() - date.getDay())).toISOString().split('T')[0];
                };

                const targetWeek = startOfWeek(new Date());
                if (targetWeek) {  // Proceed only if targetWeek is valid
                    const count = data.filter(t => startOfWeek(t.createdAt) === targetWeek).length;
                    taskVelocity.createdVelocity = count;
                }
            }

            if (task.completedAt && task.isCompleted) {
                const startOfWeek = (completedAt) => {
                    if (!completedAt) return null; // Return null if completedAt is falsy
                    const date = new Date(completedAt);
                    return new Date(date.setDate(date.getDate() - date.getDay())).toISOString().split('T')[0];
                };

                const targetWeek = startOfWeek(new Date());
                if (targetWeek) {  // Proceed only if targetWeek is valid
                    const count = data.filter(t => startOfWeek(t.completedAt) === targetWeek).length;
                    taskVelocity.completedVelocity = count;
                } 
            }
            console.log(taskVelocity)


            // Calculate Delta for Table
            let delta = (task.timeSpent / 60000 || 0) - task.timeEstimate;
            let deltaClass = delta > 0 ? "text-danger" : "text-success";
            
            // Inject Row via jQuery
            $("#task-table-body").append(`
                <tr>
                    <td>${task.name}</td>
                    <td><span class="badge bg-secondary">${task.project}</span></td>
                    <td>Tier ${task.energyLevel}</td>
                    <td>${task.focusScore}/5</td>
                    <td class="${deltaClass}">${Math.floor(delta > 0 ? '+' + delta : delta)} min</td>
                </tr>
            `);
        });

        // Update Stat Cards
        $("#m-total-time").text(`${Math.floor(totalMins/60)}h ${Math.floor(totalMins%60)}m`);
        $("#m-focus").text((sumFocus/data.filter((t) => t.isCompleted).length).toFixed(1));
        $("#m-accuracy").text(Math.round((totalEst/totalMins)*100) + "%");
        $("#m-energy").text(highEnergyCount);
        $("#m-task-velocity").text(`${taskVelocity.completedVelocity} tasks/week`);
        $("#m-task-create-velocity").text(`${taskVelocity.createdVelocity} tasks/week`);

        // Render Charts
        initCharts(data);
    }

    function initCharts(data) {
        // Project Doughnut
        const projectMap = {};
        data.forEach(t => projectMap[t.project] = (projectMap[t.project] || 0) + Math.floor(t.timeSpent / 60000));

        new Chart(document.getElementById('projectPie'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(projectMap),
                datasets: [{
                    data: Object.values(projectMap),
                    backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545']
                }]
            },
            options: { maintainAspectRatio: false }
        });

        // Accuracy Bar
        new Chart(document.getElementById('accuracyBar'), {
            type: 'bar',
            data: {
                labels: data.map(t => t.name),
                datasets: [
                    { label: 'Estimated', data: data.map(t => t.timeEstimate), backgroundColor: '#e9ecef' },
                    { label: 'Actual', data: data.map(t => t.timeSpent / 60000 || 0), backgroundColor: '#0d6efd' }
                ]
            },
            options: { maintainAspectRatio: false }
        });
    }
</script>
</body>
</html>